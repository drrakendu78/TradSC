name: Release Windows Builds

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        name: Build Windows Release
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: latest

            - name: Setup Node.js with pnpm cache
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
                  targets: x86_64-pc-windows-msvc

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Install frontend dependencies
              run: pnpm install

            - name: Build Standard Release (GitHub Distribution)
              run: |
                  Write-Host "üèóÔ∏è Building Standard (GitHub)..." -ForegroundColor Green
                  $env:TAURI_ENV_DISTRIBUTION = "github"
                  $env:TAURI_ENV_MS_STORE = $null
                  $env:TAURI_ENV_PORTABLE = $null
                  Write-Host "Variables: DISTRIBUTION=$env:TAURI_ENV_DISTRIBUTION, MS_STORE=$env:TAURI_ENV_MS_STORE, PORTABLE=$env:TAURI_ENV_PORTABLE" -ForegroundColor Yellow
                  .\scripts\build-release.ps1 standard

            - name: Build Portable Release (Portable Distribution)
              run: |
                  Write-Host "üì¶ Building Portable..." -ForegroundColor Green
                  $env:TAURI_ENV_PORTABLE = "true"
                  $env:TAURI_ENV_DISTRIBUTION = "github"
                  $env:TAURI_ENV_MS_STORE = $null
                  Write-Host "Variables: DISTRIBUTION=$env:TAURI_ENV_DISTRIBUTION, MS_STORE=$env:TAURI_ENV_MS_STORE, PORTABLE=$env:TAURI_ENV_PORTABLE" -ForegroundColor Yellow
                  .\scripts\build-release.ps1 portable

            - name: Build Microsoft Store Release (for internal use)
              run: |
                  # IMPORTANT: D√©finir explicitement les variables MS Store
                  $env:TAURI_ENV_MS_STORE = "true"
                  $env:TAURI_ENV_DISTRIBUTION = $null
                  $env:TAURI_ENV_PORTABLE = $null
                  Write-Host "üè™ Building Microsoft Store version..." -ForegroundColor Magenta
                  Write-Host "Variables: MS_STORE=$env:TAURI_ENV_MS_STORE, DISTRIBUTION=$env:TAURI_ENV_DISTRIBUTION" -ForegroundColor Yellow
                  .\scripts\build-release.ps1 msix

            - name: Rename Microsoft Store MSI for Release
              run: |
                  if (Test-Path "builds/MicrosoftStoreMSI") {
                      $storeMsi = Get-ChildItem "builds/MicrosoftStoreMSI/*.msi" | Select-Object -First 1
                      if ($storeMsi) {
                          $newName = "StarTradFR-Installer-MSStore.msi"
                          $newPath = "builds/$newName"
                          Copy-Item $storeMsi.FullName -Destination $newPath
                          Write-Host "‚úÖ Microsoft Store MSI copi√© vers: $newName" -ForegroundColor Green

                          # Ajouter au fichier checksums
                          $hash = (Get-FileHash $newPath -Algorithm SHA256).Hash.ToLower()
                          Add-Content -Path "builds/checksums.txt" -Value "$hash  $newName"
                          Write-Host "‚úÖ Checksum ajout√© pour $newName" -ForegroundColor Green
                      }
                  }

            - name: Create Updater Artifact (MSI.zip for tauri-plugin-updater)
              run: |
                  Write-Host "üì¶ Cr√©ation de l'artifact pour tauri-plugin-updater..." -ForegroundColor Cyan

                  # Extraire la version sans le 'v'
                  $version = "${{ github.ref_name }}".TrimStart('v')

                  # Trouver le MSI standard
                  $msiPath = "builds/installer/StarTradFR-Installer.msi"
                  if (-not (Test-Path $msiPath)) {
                      # Fallback sur l'ancien nom si le nouveau n'existe pas
                      $msiPath = "builds/installer/MultitoolV2-Installer.msi"
                  }

                  if (Test-Path $msiPath) {
                      # Cr√©er le zip avec le format attendu par tauri-plugin-updater
                      # Format: StarTrad FR_version_x64_fr-FR.msi.zip (fr-FR car wix.language = fr-FR)
                      $zipName = "StarTrad FR_${version}_x64_fr-FR.msi.zip"
                      $zipPath = "builds/$zipName"

                      Compress-Archive -Path $msiPath -DestinationPath $zipPath -Force
                      Write-Host "‚úÖ Updater artifact cr√©√©: $zipName" -ForegroundColor Green

                      # Ajouter le checksum
                      $hash = (Get-FileHash $zipPath -Algorithm SHA256).Hash.ToLower()
                      Add-Content -Path "builds/checksums.txt" -Value "$hash  $zipName"
                      Write-Host "‚úÖ Checksum ajout√© pour $zipName" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå MSI non trouv√© pour cr√©er l'artifact updater" -ForegroundColor Red
                      exit 1
                  }

            - name: Verify Build Artifacts
              run: |
                  Write-Host "=== V√©rification des artifacts de build ===" -ForegroundColor Cyan

                  # V√©rifier Portable (avec fallback sur ancien nom)
                  $portablePath = "builds/portable/StarTradFR-Portable.exe"
                  if (-not (Test-Path $portablePath)) {
                      $portablePath = "builds/portable/MultitoolV2-Portable.exe"
                  }
                  if (Test-Path $portablePath) {
                    Write-Host "‚úÖ Portable: $(Get-Item $portablePath | Select-Object -ExpandProperty Length) bytes" -ForegroundColor Green
                  } else {
                    Write-Host "‚ùå Portable manquant" -ForegroundColor Red
                    exit 1
                  }

                  # V√©rifier Installer (avec fallback sur ancien nom)
                  $installerPath = "builds/installer/StarTradFR-Installer.msi"
                  if (-not (Test-Path $installerPath)) {
                      $installerPath = "builds/installer/MultitoolV2-Installer.msi"
                  }
                  if (Test-Path $installerPath) {
                    Write-Host "‚úÖ Installer: $(Get-Item $installerPath | Select-Object -ExpandProperty Length) bytes" -ForegroundColor Green
                  } else {
                    Write-Host "‚ùå Installer manquant" -ForegroundColor Red
                    exit 1
                  }

                  if (Test-Path "builds/checksums.txt") {
                    Write-Host "‚úÖ Checksums disponibles" -ForegroundColor Green
                    Write-Host "Contenu:" -ForegroundColor Yellow
                    Get-Content "builds/checksums.txt"
                  } else {
                    Write-Host "‚ùå Checksums manquants" -ForegroundColor Red
                    exit 1
                  }

                  # V√©rification MS Store MSI (avec fallback)
                  $msStorePath = "builds/StarTradFR-Installer-MSStore.msi"
                  if (-not (Test-Path $msStorePath)) {
                      $msStorePath = "builds/MultitoolV2-Installer-MSStore.msi"
                  }
                  if (Test-Path $msStorePath) {
                    Write-Host "‚úÖ MS Store MSI: $(Get-Item $msStorePath | Select-Object -ExpandProperty Length) bytes" -ForegroundColor Green
                  } else {
                    Write-Host "‚ùå MS Store MSI manquant" -ForegroundColor Red
                    exit 1
                  }

                  # V√©rification Updater artifact (MSI.zip)
                  $version = "${{ github.ref_name }}".TrimStart('v')
                  $updaterPath = "builds/StarTrad FR_${version}_x64_fr-FR.msi.zip"
                  if (Test-Path $updaterPath) {
                    Write-Host "‚úÖ Updater artifact: $(Get-Item $updaterPath | Select-Object -ExpandProperty Length) bytes" -ForegroundColor Green
                  } else {
                    Write-Host "‚ùå Updater artifact manquant" -ForegroundColor Red
                    exit 1
                  }

            - name: Create Release Notes
              run: |
                  $version = "${{ github.ref_name }}"
                  $notes = @"
                  # StarTrad FR $version - Release Windows (Non-sign√©)

                  ## ‚ö†Ô∏è Avertissement S√©curit√© - Builds Non-sign√©s

                  Cette application n'est **pas sign√©e num√©riquement** (certificat co√ªteux pour un projet open-source).
                  Windows SmartScreen affichera un avertissement - c'est **normal et attendu**.

                  ## üì• Options d'Installation

                  1. **üèÜ RECOMMAND√â - Version Portable** : Aucune installation, pas d'avertissement SmartScreen
                  2. **üíª Installer Standard** : Avertissement SmartScreen attendu (cliquez "Informations compl√©mentaires" ‚Üí "Ex√©cuter quand m√™me")
                  3. **üîÑ Mise √† jour automatique** : Si vous avez d√©j√† StarTrad FR, l'app se mettra √† jour automatiquement

                  ## üîê V√©rification de S√©curit√©

                  - ‚úÖ **Code source ouvert** : Enti√®rement auditable sur GitHub
                  - ‚úÖ **Build reproductible** : Workflow GitHub Actions public
                  - ‚úÖ **Checksums SHA256** : V√©rification d'int√©grit√© fournie ci-dessous

                  ## üìã Checksums SHA256

                  ``````
                  $(Get-Content builds/checksums.txt -Raw)
                  ``````

                  ### Comment installer une app non-sign√©e sur Windows :
                  1. T√©l√©chargez le fichier souhait√©
                  2. Si SmartScreen appara√Æt : **"Informations compl√©mentaires"** ‚Üí **"Ex√©cuter quand m√™me"**
                  3. Ou utilisez la **version portable** (recommand√© - pas d'installation)

                  ---
                  **Pourquoi pas de signature ?** Les certificats de signature co√ªtent ~300‚Ç¨/an.
                  Pour un projet gratuit et open-source, nous privil√©gions la transparence totale du code.
                  "@

                  $notes | Out-File -FilePath "RELEASE_NOTES.md" -Encoding utf8

            - name: Upload Release Assets (Public uniquement)
              uses: softprops/action-gh-release@v1
              with:
                  body_path: RELEASE_NOTES.md
                  files: |
                      builds/portable/StarTradFR-Portable.exe
                      builds/portable/MultitoolV2-Portable.exe
                      builds/installer/StarTradFR-Installer.msi
                      builds/installer/MultitoolV2-Installer.msi
                      builds/StarTradFR-Installer-MSStore.msi
                      builds/MultitoolV2-Installer-MSStore.msi
                      builds/StarTrad FR_*_x64_fr-FR.msi.zip
                      builds/checksums.txt
                  prerelease: false
                  generate_release_notes: false
                  fail_on_unmatched_files: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Summary
              run: |
                  Write-Host ""
                  Write-Host "üéâ RELEASE CR√â√âE AVEC SUCC√àS!" -ForegroundColor Green
                  Write-Host "Version: ${{ github.ref_name }}" -ForegroundColor Cyan
                  Write-Host ""
                  Write-Host "üì¶ Artifacts dans GitHub Release:" -ForegroundColor Yellow
                  Write-Host "  ‚Ä¢ StarTradFR-Portable.exe (Recommand√©)" -ForegroundColor White
                  Write-Host "  ‚Ä¢ StarTradFR-Installer.msi (Standard)" -ForegroundColor White
                  Write-Host "  ‚Ä¢ StarTrad FR_*_x64_fr-FR.msi.zip (Auto-updater)" -ForegroundColor Green
                  Write-Host "  ‚Ä¢ checksums.txt" -ForegroundColor White
                  Write-Host ""
                  Write-Host "üîÑ Mise √† jour automatique:" -ForegroundColor Green
                  Write-Host "   Le fichier .msi.zip permet aux utilisateurs existants" -ForegroundColor White
                  Write-Host "   de recevoir automatiquement cette mise √† jour" -ForegroundColor White
                  Write-Host ""
                  Write-Host "üåê Release disponible sur:" -ForegroundColor Cyan
                  Write-Host "   https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Blue
