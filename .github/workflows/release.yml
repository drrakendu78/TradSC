name: Release Windows Builds

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        name: Build Windows Release
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: latest

            - name: Setup Node.js with pnpm cache
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
                  targets: x86_64-pc-windows-msvc

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Install frontend dependencies
              run: pnpm install

            - name: Create builds directory
              run: |
                  New-Item -ItemType Directory -Force -Path "builds/portable"
                  New-Item -ItemType Directory -Force -Path "builds/installer"

            - name: Build Tauri App (MSI + NSIS)
              run: pnpm tauri build
              env:
                  TAURI_ENV_DISTRIBUTION: github

            - name: Collect Build Artifacts
              run: |
                  Write-Host "üì¶ Collecte des artifacts..." -ForegroundColor Cyan
                  $version = "${{ github.ref_name }}".TrimStart('v')
                  $tauriRelease = "src-tauri/target/release/bundle"

                  # MSI
                  $msi = Get-ChildItem "$tauriRelease/msi/*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($msi) {
                      Copy-Item $msi.FullName -Destination "builds/installer/StarTradFR-Installer.msi"
                      Write-Host "‚úÖ MSI copi√©: $($msi.Name)" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå MSI non trouv√©" -ForegroundColor Red
                      exit 1
                  }

                  # NSIS (EXE installer) - nom compatible avec l'ancien updater
                  $nsis = Get-ChildItem "$tauriRelease/nsis/*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($nsis) {
                      $setupName = "StarTrad.FR_${version}_x64-setup.exe"
                      Copy-Item $nsis.FullName -Destination "builds/$setupName"
                      Write-Host "‚úÖ NSIS Setup copi√©: $setupName" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå NSIS non trouv√©" -ForegroundColor Red
                      exit 1
                  }

                  # Portable (exe brut sans installer)
                  $portable = "src-tauri/target/release/startradfr.exe"
                  if (Test-Path $portable) {
                      Copy-Item $portable -Destination "builds/StarTradFR-Portable.exe"
                      Write-Host "‚úÖ Portable copi√©: StarTradFR-Portable.exe" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå Portable non trouv√©" -ForegroundColor Red
                      exit 1
                  }

                  # Cr√©er checksums
                  $checksums = @()
                  Get-ChildItem "builds/installer/*.msi", "builds/*.exe" | ForEach-Object {
                      $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
                      $checksums += "$hash  $($_.Name)"
                      Write-Host "Hash: $hash  $($_.Name)" -ForegroundColor Yellow
                  }
                  $checksums | Out-File -FilePath "builds/checksums.txt" -Encoding utf8
                  Write-Host "‚úÖ Checksums cr√©√©s" -ForegroundColor Green

            - name: Create Updater Artifact (NSIS.zip for tauri-plugin-updater)
              run: |
                  Write-Host "üì¶ Cr√©ation de l'artifact pour tauri-plugin-updater..." -ForegroundColor Cyan

                  $version = "${{ github.ref_name }}".TrimStart('v')
                  $nsisPath = "builds/StarTrad.FR_${version}_x64-setup.exe"

                  if (Test-Path $nsisPath) {
                      # Format attendu par tauri-plugin-updater: ProductName_version_arch_locale.nsis.zip
                      $zipName = "StarTrad.FR_${version}_x64-setup.nsis.zip"
                      $zipPath = "builds/$zipName"

                      Compress-Archive -Path $nsisPath -DestinationPath $zipPath -Force
                      Write-Host "‚úÖ Updater artifact cr√©√©: $zipName" -ForegroundColor Green

                      # Ajouter le checksum
                      $hash = (Get-FileHash $zipPath -Algorithm SHA256).Hash.ToLower()
                      Add-Content -Path "builds/checksums.txt" -Value "$hash  $zipName"
                      Write-Host "‚úÖ Checksum ajout√© pour $zipName" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå NSIS non trouv√© pour cr√©er l'artifact updater" -ForegroundColor Red
                      exit 1
                  }

            - name: Verify Build Artifacts
              run: |
                  Write-Host "=== V√©rification des artifacts ===" -ForegroundColor Cyan
                  $version = "${{ github.ref_name }}".TrimStart('v')

                  $portable = "builds/StarTradFR-Portable.exe"
                  $setup = "builds/StarTrad.FR_${version}_x64-setup.exe"
                  $installer = "builds/installer/StarTradFR-Installer.msi"
                  $updater = "builds/StarTrad.FR_${version}_x64-setup.nsis.zip"

                  if (Test-Path $portable) {
                      Write-Host "‚úÖ Portable: $([math]::Round((Get-Item $portable).Length / 1MB, 2)) MB" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå Portable manquant" -ForegroundColor Red
                      exit 1
                  }

                  if (Test-Path $setup) {
                      Write-Host "‚úÖ Setup NSIS: $([math]::Round((Get-Item $setup).Length / 1MB, 2)) MB" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå Setup NSIS manquant" -ForegroundColor Red
                      exit 1
                  }

                  $installer = "builds/installer/StarTradFR-Installer.msi"
                  if (Test-Path $installer) {
                      Write-Host "‚úÖ MSI Installer: $([math]::Round((Get-Item $installer).Length / 1MB, 2)) MB" -ForegroundColor Green
                  } else {
                      Write-Host "‚ö†Ô∏è MSI Installer manquant (optionnel)" -ForegroundColor Yellow
                  }

                  if (Test-Path $updater) {
                      Write-Host "‚úÖ NSIS ZIP (updater): $([math]::Round((Get-Item $updater).Length / 1MB, 2)) MB" -ForegroundColor Green
                  } else {
                      Write-Host "‚ùå Updater ZIP manquant" -ForegroundColor Red
                      exit 1
                  }

                  Write-Host ""
                  Write-Host "Checksums:" -ForegroundColor Yellow
                  Get-Content "builds/checksums.txt"

            - name: Create Release Notes
              shell: pwsh
              run: |
                  $version = "${{ github.ref_name }}"
                  $checksums = Get-Content builds/checksums.txt -Raw
                  $notes = @"
                  # StarTrad FR $version

                  ## Telechargements

                  - **StarTradFR-Portable.exe** - Recommande, aucune installation requise
                  - **StarTrad.FR_x.x.x_x64-setup.exe** - Installateur NSIS
                  - **StarTradFR-Installer.msi** - Installation classique Windows (alternatif)

                  ## Note Windows SmartScreen

                  Cette application n'est pas signee numeriquement. Windows affichera un avertissement.
                  Cliquez Informations complementaires puis Executer quand meme

                  ## Verification d'integrite

                  Checksums SHA256:
                  $checksums

                  ## Mise a jour automatique

                  Les utilisateurs existants recevront automatiquement cette mise a jour.
                  "@
                  $notes | Out-File -FilePath "RELEASE_NOTES.md" -Encoding utf8

            - name: Upload Release Assets
              uses: softprops/action-gh-release@v1
              with:
                  body_path: RELEASE_NOTES.md
                  files: |
                      builds/StarTradFR-Portable.exe
                      builds/StarTrad.FR_*_x64-setup.exe
                      builds/installer/StarTradFR-Installer.msi
                      builds/StarTrad.FR_*_x64-setup.nsis.zip
                      builds/checksums.txt
                  prerelease: false
                  generate_release_notes: false
                  fail_on_unmatched_files: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Summary
              run: |
                  Write-Host ""
                  Write-Host "üéâ RELEASE CR√â√âE AVEC SUCC√àS!" -ForegroundColor Green
                  Write-Host "Version: ${{ github.ref_name }}" -ForegroundColor Cyan
                  Write-Host ""
                  Write-Host "üì¶ Artifacts:" -ForegroundColor Yellow
                  Write-Host "  ‚Ä¢ StarTradFR-Portable.exe" -ForegroundColor White
                  Write-Host "  ‚Ä¢ StarTrad.FR_*_x64-setup.exe (NSIS)" -ForegroundColor White
                  Write-Host "  ‚Ä¢ StarTradFR-Installer.msi" -ForegroundColor White
                  Write-Host "  ‚Ä¢ StarTrad.FR_*_x64-setup.nsis.zip (Auto-updater)" -ForegroundColor Green
                  Write-Host ""
                  Write-Host "üåê https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Blue
